Pytorch

## ModuleList 和 Sequential

参考 [详解PyTorch中的ModuleList和Sequential](https://zhuanlan.zhihu.com/p/75206669)


### Sequential
nn.Sequential里面的模块按照顺序进行排列的，所以必须确保前一个模块的输出大小和下一个模块的输入大小是一致的， 可以使用OrderedDict来指定每个module的名字

```python
from collections import OrderedDict

class net_seq(nn.Module):
    def __init__(self):
        super(net_seq, self).__init__()
        self.seq = nn.Sequential(OrderedDict([
                        ('conv1', nn.Conv2d(1,20,5)),
                         ('relu1', nn.ReLU()),
                          ('conv2', nn.Conv2d(20,64,5)),
                       ('relu2', nn.ReLU())
                       ]))
    def forward(self, x):
        return self.seq(x)
net_seq = net_seq()
print(net_seq)
#net_seq(
#  (seq): Sequential(
#    (conv1): Conv2d(1, 20, kernel_size=(5, 5), stride=(1, 1))
#    (relu1): ReLU()
#    (conv2): Conv2d(20, 64, kernel_size=(5, 5), stride=(1, 1))
#    (relu2): ReLU()
#  )
#)
```

### ModuleList
nn.ModuleList 可以把任意 nn.Module 的子类加到这个 list 里面，不同于一般的 list，加入到 nn.ModuleList 里面的 module 是会自动注册到整个网络上的，一般的 list 则会使得在训练的时候网络参数无法更新

```python
class net_modlist(nn.Module):
    def __init__(self):
        super(net_modlist, self).__init__()
        self.modlist = nn.ModuleList([
                       nn.Conv2d(1, 20, 5),
                       nn.ReLU(),
                        nn.Conv2d(20, 64, 5),
                        nn.ReLU()
                        ])

    def forward(self, x):
        for m in self.modlist:
            x = m(x)
        return x

net_modlist = net_modlist()
print(net_modlist)
#net_modlist(
#  (modlist): ModuleList(
#    (0): Conv2d(1, 20, kernel_size=(5, 5), stride=(1, 1))
#    (1): ReLU()
#    (2): Conv2d(20, 64, kernel_size=(5, 5), stride=(1, 1))
#    (3): ReLU()
#  )
#)

for param in net_modlist.parameters():
    print(type(param.data), param.size())
#<class 'torch.Tensor'> torch.Size([20, 1, 5, 5])
#<class 'torch.Tensor'> torch.Size([20])
#<class 'torch.Tensor'> torch.Size([64, 20, 5, 5])
#<class 'torch.Tensor'> torch.Size([64])
```

### nn.Sequential与nn.ModuleList的区别

1. nn.Sequential 默认实现了 forward 函数，无需再写 forward 函数可以直接使用模型，多用于组织卷积块后再将不同的 block 拼接成网络
2. nn.Sequential 每层都可以命名
3. nn.Sequential 每层是有序的，并且上一层的输出和下一层的输入参数必须大小一致，而 ModuleList 则可以灵活的在 forward 函数中自定义
4. 重复层考虑使用 for 循环来创建时， ModuleList 会更方便

